function MonthTable(a,b){a=a||new Date,b=b||document.body;var c=this,d=a.getFullYear(),e=a.getMonth()+1,f=new Date(d,e,0).getDate(),g=new Date(d,e-1,1).getDay();g=0==g?6:g-1;var h=0;d==(new Date).getFullYear()&&e-1==(new Date).getMonth()&&(h=(new Date).getDate());for(var i=Math.ceil((f+g)/7),j=MonthTable.templates.monthTable.cloneNode(!0),k=0,l=1-g;i>k;k++){j.appendChild(MonthTable.templates.monthTable__row.cloneNode(!0));for(var m=0;7>m&&f>=l;m++,l++){var n=d+"-"+(e>9?e:"0"+e)+"-"+(l>9?l:"0"+l);localStorage[n+"_eventName"]?(j.children[k].appendChild(MonthTable.templates.monthTable__cell_filled.cloneNode(!0)),j.children[k].children[m].classList.add("monthTable__cell_filled"),j.children[k].children[m].getElementsByTagName("h1")[0].innerHTML=localStorage[n+"_eventName"],j.children[k].children[m].getElementsByTagName("span")[0].innerHTML=localStorage[n+"_eventAttendanceList"]):j.children[k].appendChild(MonthTable.templates.monthTable__cell.cloneNode(!0)),0>=l?(j.children[k].children[m].classList.add("monthTable__cell_empty"),j.children[k].children[m].children[0].innerHTML=""):(j.children[k].children[m].children[0].innerHTML=l,j.children[k].children[m].children[0].setAttribute("datetime",n),l==h&&j.children[k].children[m].classList.add("monthTable__cell_today"))}}for(var k=0;7>k;k++){var o=j.children[0].children[k].children[0];o.innerHTML=""==o.innerHTML?dayNames[k]:dayNames[k]+", "+o.innerHTML}this.node=j,this.selectedCell,this.date=a,this.placeBefore=function(a,c,d){d=d||b,this.node.style.left=a||this.node.style.left,this.node.style.top=c||this.node.style.top,d.parentNode.insertBefore(this.node,d)},this.changeDate=function(a){this.date=a;var b=this.node.onclick;this.node.parentNode.removeChild(this.node),this.node=new MonthTable(a).node.cloneNode(!0),this.node.onclick=b},this.updateView=function(a){a=a||this.date,this.changeDate(a),this.placeBefore(),this.clearSelection()},this.makeDateString=function(a,b){if(!a&&!b){var c=this.selectedCell.getElementsByTagName("time")[0].getAttribute("datetime")+"_";b=+c.slice(8,10),a=+c.slice(5,7)-1}return b+" "+monthNamesInCase[a]},this.clearSelection=function(){this.selectedCell&&(this.selectedCell.classList.remove("monthTable__cell_selected"),this.selectedCell=null)},this.selectCell=function(a,b,c){var d,e=new Date;c?d=new Date(c,a,b):(console.log("today.getMonth()"+e.getMonth()),console.log("month"+a),console.log("today.getDate()"+e.getDate()),console.log("day"+b),d=e.getMonth()>a||e.getMonth()==a&&e.getDate()>b?new Date(e.getFullYear()+1,a,b):new Date(e.getFullYear(),a,b));var f=new Date(d.getFullYear(),a+1,0).getDate();b>f&&(b=f,d=new Date(d.getFullYear(),a,b));var g=new Date(d.getFullYear(),a,1).getDay();g=0==g?6:g-1;var h=Math.floor((g+b-1)/7),i=b+g-7*h-1;console.log(i),this.updateView(d),this.selectedCell=this.node.getElementsByClassName("monthTable__row")[h].getElementsByClassName("monthTable__cell")[i],this.selectedCell.classList.add("monthTable__cell_selected"),console.log(this.date)},this.addController=function(a,b,d){d=d||"onclick","onclick"==d&&(a.onclick=function(d){b=b.bind(a),b(c,d)})},this.initController=function(a){a(c)}}function Search(){var a=this;this.resultsNode=null,this.boxNode=null,this.inputNode=null,this.itemListNode=null,this.scroll=null,this.inputClear=null,this.resultsNode=document.getElementById("searchResults"),this.itemListNode=this.resultsNode.getElementsByClassName("searchResults_itemList")[0],this.items=this.resultsNode.getElementsByClassName("searchResults__item"),this.itemListNode.removeChild(this.items[0]),this.itemListNode.removeChild(this.items[0]),this.scroll=this.resultsNode.getElementsByClassName("searchResults__scroll")[0],this.linkInput=function(b){this.boxNode=b,this.inputNode=this.boxNode.getElementsByClassName("search__input")[0],9>=IE&&(this.inputNode=this.boxNode.getElementsByClassName("search__input")[1]),this.inputClear=this.boxNode.getElementsByClassName("input__clear")[0],addEvent(this.inputNode,"focus",function(){""!=a.inputNode.value&&a.resultsNode.classList.remove("invisible")}),this.inputNode.onkeyup=function(){a.inputClear.classList.remove("invisible"),""==a.inputNode.value&&a.inputClear.classList.add("invisible");var b=a.findResults(a.inputNode.value);if(a.showResults(b)&&a.resultsNode.classList.remove("invisible"),a.itemListNode.scrollHeight>a.itemListNode.clientHeight){var c=Math.round(a.itemListNode.clientHeight*a.itemListNode.clientHeight/a.itemListNode.scrollHeight);console.log(c),a.scroll.style.height=c+"px",a.scroll.classList.remove("invisible")}else a.scroll.classList.add("invisible")},this.boxNode.onclick=function(b){b=b||window.event;for(var c=b.target||b.srcElement;c!=a.inputClear;){if(c==this)return 9>=IE&&a.inputNode.classList.remove("hidden"),a.inputNode.focus(),void 0;c=c.parentNode}a.inputClear.classList.add("invisible"),a.resultsNode.classList.add("invisible"),a.inputNode.value="",a.inputNode.focus()}},this.findResults=function(a){if(items=[],""==a)return items;for(var b="",c=sortKeys(localStorage,!0),d=0;d<c.length;d++){var e=c[d];if(b!=e.slice(0,10)+"_"&&(" "+localStorage[e].toLowerCase()).indexOf((" "+a).toLowerCase())>=0){items.push({});var f=items.length-1,b=e.slice(0,10)+"_";items[f].date=e.slice(0,10),items[f].header=localStorage[b+"eventName"],items[f].text=localStorage[b+"eventDate"]}}return items},this.showResults=function(a){for(var b=0;b<this.items.length;)this.itemListNode.removeChild(this.items[0]);for(var b=0;b<a.length;b++){var c=Search.templates.item.cloneNode(!0);this.itemListNode.appendChild(c),c.getElementsByClassName("searchResults__itemHeader")[0].innerHTML=a[b].header,c.getElementsByClassName("searchResults__itemText")[0].innerHTML=a[b].text,c.getElementsByClassName("searchResults__itemText")[0].setAttribute("datetime",a[b].date)}return 0==a.length?!1:!0},this.hideResults=function(){this.resultsNode.classList.add("invisible")},this.itemListNode.onclick=function(b){b=b||window.event;for(var c=b.target||b.srcElement,d=0;d<a.items.length;d++)a.items[d].children[0].classList.remove("searchResults__itemSelectArea_selected");for(;!c.classList.contains("searchResults__itemSelectArea");){if(c==this)return;c=c.parentNode}c.classList.add("searchResults__itemSelectArea_selected")},this.itemListNode.onscroll=function(){var b=10,c=Math.round(a.itemListNode.scrollTop*a.itemListNode.clientHeight/a.itemListNode.scrollHeight);b>c?c=b:c>a.itemListNode.clientHeight-a.scroll.clientHeight+b&&(c=a.itemListNode.clientHeight-a.scroll.clientHeight-b),a.scroll.style.top=c+"px"}}function sortKeys(a,b){b=b||!1;var c=[];for(key in a)c.push(key);return b?c.sort(function(a,b){return a>b?-1:b>a?1:0}):c.sort(function(a,b){return a>b?1:b>a?-1:0}),c}function monthTableMainOnclick(a,b){b=b||window.event;for(var c=b.target||b.srcElement;!c.classList.contains("monthTable__cell");){if(c==this)return;c=c.parentNode}if(!c.classList.contains("monthTable__cell_empty")){var d=c.classList.contains("monthTable__cell_selected");if(a.clearSelection(),d)hideDetailForm();else{c.classList.add("monthTable__cell_selected"),a.selectedCell=c;var e=a.selectedCell.getElementsByTagName("time")[0].getAttribute("datetime")+"_";showDetailForm(a,localStorage[e+"eventName"],a.makeDateString(),localStorage[e+"eventAttendanceList"],localStorage[e+"eventDescription"])}}}function monthSelectorOnclick(a,b){b=b||window.event;for(var c=b.target||b.srcElement,d=a.date;!c.classList.contains("monthSelector__buttonLeft")&&!c.classList.contains("monthSelector__buttonRight")&&!c.classList.contains("monthSelector__buttonToday");){if(c==this)return;c=c.parentNode}c.classList.contains("monthSelector__buttonLeft")?(a.changeDate(new Date(d.getFullYear(),d.getMonth()-1,1)),a.placeBefore()):c.classList.contains("monthSelector__buttonRight")?(a.changeDate(new Date(d.getFullYear(),d.getMonth()+1,1)),a.placeBefore()):c.classList.contains("monthSelector__buttonToday")&&(a.changeDate(new Date),a.placeBefore()),d=a.date;var e=this.getElementsByClassName("monthSelector__month")[0];e.innerHTML=monthNames[d.getMonth()]+" "+d.getFullYear(),detailForm.classList.add("invisible")}function monthSelectorInitialiser(a){var b=monthSelector.getElementsByClassName("monthSelector__month")[0];b.innerHTML=monthNames[a.date.getMonth()]+" "+a.date.getFullYear(),monthSelector.onmousedown=monthSelector.onselectstart=function(){return!1}}function basicFormOnclick(a,b){b=b||window.event;var c=b.target||b.srcElement;if(c.classList.contains("popup__close"))this.classList.add("invisible");else if(c.classList.contains("button_submit")){for(var d=this.getElementsByTagName("input"),e=0;e<d.length;e++)if("eventString"==d[e].getAttribute("name")){var f=d[e].value;break}if(f){var g=addEventBasicRegExp.exec(f);if(!g)return;if(+g[1]<1||+g[1]>31)return;g[2]=g[2].slice(0,3);for(var h,e=0;e<monthNamesInCase.length;e++)g[2].toLowerCase()==monthNamesInCase[e].slice(0,3).toLowerCase()&&(h=e);if(!h)return;a.selectCell(h,+g[1]);var i=monthSelector.getElementsByClassName("monthSelector__month")[0];i.innerHTML=monthNames[a.date.getMonth()]+" "+a.date.getFullYear(),this.classList.add("invisible"),showDetailForm(a,g[5],a.makeDateString())}}}function detailFormOnclick(a,b){b=b||window.event;var c=b.target||b.srcElement,d=a.selectedCell.getElementsByTagName("time")[0].getAttribute("datetime")+"_";if(c.classList.contains("popup__close"))a.clearSelection(),this.classList.add("invisible");else if(c.classList.contains("button_submit")){if(""!=detailFormInputFields[0].value){try{localStorage[d+"eventName"]=detailFormInputFields[0].value,localStorage[d+"eventAttendanceList"]=detailFormInputFields[2].value,localStorage[d+"eventDescription"]=detailFormInputFields[3].value,localStorage[d+"eventDate"]=a.makeDateString()}catch(e){e==QUOTA_EXCEEDED_ERR&&alert("Локальное хранилище переполнено")}a.updateView(),hideDetailForm()}}else c.classList.contains("button_cancel")&&(localStorage.removeItem(d+"eventName"),localStorage.removeItem(d+"eventAttendanceList"),localStorage.removeItem(d+"eventDescription"),localStorage.removeItem(d+"eventDate"),a.updateView(),hideDetailForm())}function addEventBasicButtonOnclick(a,b){b=b||window.event,b.target||b.srcElement,a.clearSelection(),toggleBasicForm(a)}function showDetailForm(a){basicForm.classList.add("invisible"),detailForm.getElementsByClassName("popupArrow")&&detailForm.removeChild(detailForm.getElementsByClassName("popupArrow")[0]);var b={},c=a.node.children[0].getBoundingClientRect(),d=a.selectedCell.getBoundingClientRect();b.top=d.top-c.top,b.left=d.left-c.left;var e={};e.width=d.right-d.left,e.height=d.bottom-d.top;var f={};f.v=Math.round(b.top/e.height),f.h=Math.round(b.left/e.width);var g={};g.v=f.v<=2?"top":"bottom",g.h=f.h<=3?"right":"left";var h=document.createElement("div");h.classList.add("popupArrow"),h.classList.add("popupArrow_"+g.h);var i=20,j=0,k=12,l=27;"top"==g.v?(h.style.top=i+j+"px",h.style.bottom=null):(h.style.bottom=i+e.height-j-l+"px",h.style.top=null);var m={},n=detailForm.getBoundingClientRect();m.width=n.right-n.left,m.height=n.bottom-n.top,detailForm.style.top="top"==g.v?b.top+c.top-i+"px":b.top-m.height+e.height+c.top+i+"px",detailForm.style.left="right"==g.h?b.left+e.width+c.left+k+"px":b.left-m.width+c.left-k+"px",arguments[1]?showReadyField(0,arguments[1]):showInputField(0),arguments[2]?showReadyField(1,arguments[2]):showInputField(1),arguments[3]?showReadyField(2,arguments[3],"<div class='popup__subheader'>Участники:</div>"+arguments[3]):showInputField(2),arguments[4]?(detailFormInputFields[3].value=arguments[4],detailForm.getElementsByClassName("placeholder").length>0&&(detailForm.getElementsByClassName("placeholder")[3].classList.add("hidden"),detailFormInputFields[3].classList.remove("hidden"))):(detailFormInputFields[3].value="",detailForm.getElementsByClassName("placeholder").length>0&&(detailForm.getElementsByClassName("placeholder")[3].classList.remove("hidden"),detailFormInputFields[3].classList.add("hidden"))),detailForm.appendChild(h),detailForm.classList.remove("invisible")}function hideDetailForm(){detailForm.classList.add("invisible")}function toggleBasicForm(){detailForm.classList.add("invisible"),basicForm.classList.toggle("invisible")}function hideBasicForm(){basicForm.classList.add("invisible")}function getDetailFormInputFields(){for(var a=["none","none","none","none"],b=detailForm.getElementsByTagName("input"),c=0;c<b.length;c++)"eventName"==b[c].getAttribute("name")&&(a[0]=b[c]),"eventDate"==b[c].getAttribute("name")&&(a[1]=b[c]),"eventAttendanceList"==b[c].getAttribute("name")&&(a[2]=b[c]);return a[3]=document.getElementsByName("eventDescription")[0],a}function showReadyField(a,b,c){c=c||b;var d;switch(a){case 0:d=detailForm.getElementsByClassName("popup__header")[0];break;case 1:d=detailForm.getElementsByTagName("time")[0];break;case 2:d=document.getElementsByClassName("detailForm__attendanceList")[0]}d.classList.remove("hidden"),d.innerHTML=c,detailFormInputFields[a].classList.add("hidden"),detailFormInputFields[a].value=b,9>=IE&&detailForm.getElementsByClassName("placeholder")[a].classList.add("hidden")}function showInputField(a){var b;switch(a){case 0:b=detailForm.getElementsByClassName("popup__header")[0];break;case 1:b=detailForm.getElementsByTagName("time")[0];break;case 2:b=document.getElementsByClassName("detailForm__attendanceList")[0]}b.classList.add("hidden"),detailFormInputFields[a].classList.remove("hidden"),detailFormInputFields[a].value="",9>=IE&&(detailFormInputFields[a].classList.add("hidden"),detailForm.getElementsByClassName("placeholder")[a].classList.remove("hidden"))}!function(){for(var a,b=function(){},c=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],d=c.length,e=window.console=window.console||{};d--;)a=c[d],e[a]||(e[a]=b)}(),"undefined"==typeof document||"classList"in document.createElement("a")||!function(a){"use strict";if("HTMLElement"in a||"Element"in a){var b="classList",c="prototype",d=(a.HTMLElement||a.Element)[c],e=Object,f=String[c].trim||function(){return this.replace(/^\s+|\s+$/g,"")},g=Array[c].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},h=function(a,b){this.name=a,this.code=DOMException[a],this.message=b},i=function(a,b){if(""===b)throw new h("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(b))throw new h("INVALID_CHARACTER_ERR","String contains an invalid character");return g.call(a,b)},j=function(a){for(var b=f.call(a.className),c=b?b.split(/\s+/):[],d=0,e=c.length;e>d;d++)this.push(c[d]);this._updateClassName=function(){a.className=this.toString()}},k=j[c]=[],l=function(){return new j(this)};if(h[c]=Error[c],k.item=function(a){return this[a]||null},k.contains=function(a){return a+="",-1!==i(this,a)},k.add=function(){var a,b=arguments,c=0,d=b.length,e=!1;do a=b[c]+"",-1===i(this,a)&&(this.push(a),e=!0);while(++c<d);e&&this._updateClassName()},k.remove=function(){var a,b=arguments,c=0,d=b.length,e=!1;do{a=b[c]+"";var f=i(this,a);-1!==f&&(this.splice(f,1),e=!0)}while(++c<d);e&&this._updateClassName()},k.toggle=function(a,b){a+="";var c=this.contains(a),d=c?b!==!0&&"remove":b!==!1&&"add";return d&&this[d](a),!c},k.toString=function(){return this.join(" ")},e.defineProperty){var m={get:l,enumerable:!0,configurable:!0};try{e.defineProperty(d,b,m)}catch(n){-2146823252===n.number&&(m.enumerable=!1,e.defineProperty(d,b,m))}}else e[c].__defineGetter__&&d.__defineGetter__(b,l)}}(self);var addEvent,removeEvent;document.addEventListener?(addEvent=function(a,b,c){a.addEventListener(b,c,!1)},removeEvent=function(a,b,c){a.removeEventListener(b,c,!1)}):(addEvent=function(a,b,c){a.attachEvent("on"+b,c)},removeEvent=function(a,b,c){a.detachEvent("on"+b,c)});var IE=100;document.getElementsByTagName("html")[0].classList.contains("lt-ie10")?IE=9:document.getElementsByTagName("html")[0].classList.contains("lt-ie9")?IE=8:document.getElementsByTagName("html")[0].classList.contains("lt-ie8")?IE=7:document.getElementsByTagName("html")[0].classList.contains("lt-ie7")&&(IE=6),function(){if(document.getElementsByTagName("html")[0].classList.contains("lt-ie10")){for(var a=document.getElementsByTagName("input"),b=document.getElementsByTagName("textarea"),c=[],d=[],e=0;e<a.length;e++)c.push(a[e]);for(var e=0;e<b.length;e++)c.push(b[e]);for(var e=0;e<c.length;e++){var f=c[e].getAttribute("type");("text"==f||"search"==f||"TEXTAREA"==c[e].tagName)&&(d[e]=c[e].cloneNode(),d[e].value=c[e].getAttribute("placeholder"),d[e].number=e,d[e].onfocus=function(){this.classList.add("hidden"),c[this.number].classList.remove("hidden"),c[this.number].focus()},d[e].classList.add("placeholder"),d[e].removeAttribute("name"),d[e].removeAttribute("id"),c[e].classList.add("hidden"),c[e].number=e,c[e].onblur=function(){""==this.value&&(this.classList.add("hidden"),d[this.number].classList.remove("hidden"),console.log(this.number))},c[e].onfocus=function(){d[this.number].classList.add("hidden")},c[e].parentNode.insertBefore(d[e],c[e]))}}}();var dayNames=["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"],monthNames=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthNamesInCase=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];MonthTable.setTemplates=function(){var a=document.getElementsByClassName("monthTableTemplate");this.templates={};for(var b=0;b<a.length;b++)a[b].classList.contains("monthTable")?(this.templates.monthTable=a[b].cloneNode(!1),this.templates.monthTable.classList.remove("monthTableTemplate"),this.templates.monthTable.classList.remove("hidden"),this.templates.monthTable.id=""):a[b].classList.contains("monthTable__row")?(this.templates.monthTable__row=a[b].cloneNode(!1),this.templates.monthTable__row.classList.remove("monthTableTemplate"),this.templates.monthTable__row.id=""):a[b].classList.contains("monthTable__cell")&&!a[b].classList.contains("monthTable__cell_filled")?(this.templates.monthTable__cell=a[b].cloneNode(!0),this.templates.monthTable__cell.classList.remove("monthTableTemplate"),this.templates.monthTable__cell.id=""):a[b].classList.contains("monthTable__cell_filled")&&(this.templates.monthTable__cell_filled=a[b].cloneNode(!0),this.templates.monthTable__cell_filled.classList.remove("monthTableTemplate"),this.templates.monthTable__cell_filled.id="")},function(){for(var a=document.getElementsByClassName("customButton"),b=0;b<a.length;b++)a[b].onmousedown=function(){this.classList.add(this.classList[1]+"_pressed")},a[b].onmouseup=function(){this.classList.remove(this.classList[1]+"_pressed")}}(),Search.setTemplates=function(){this.templates={},this.templates.item=document.getElementsByClassName("searchResultsTemplate")[0].cloneNode(!0),this.templates.item.classList.remove("searchResultsTemplate")};var monthSelector=document.getElementById("monthSelector"),basicForm=document.getElementById("basicForm"),detailForm=document.getElementById("detailForm"),addEventBasicButton=document.getElementById("addEventBasic"),detailFormInputFields=getDetailFormInputFields(),addEventBasicRegExp=/(\d{1,2})\s([А-ЯЁа-я]{3,8})\s?,\s?(\d{1,2}):(\d{2})\s?,\s?([\d\D]+)/;MonthTable.setTemplates(),monthTableMain=new MonthTable(new Date,document.getElementById("monthTable")),monthTableMain.placeBefore(),monthTableMain.addController(monthSelector,monthSelectorOnclick),monthTableMain.addController(monthTableMain.node,monthTableMainOnclick),monthTableMain.addController(basicForm,basicFormOnclick),monthTableMain.addController(detailForm,detailFormOnclick),monthTableMain.addController(addEventBasicButton,addEventBasicButtonOnclick),monthTableMain.initController(monthSelectorInitialiser),Search.setTemplates();var searchMain=new Search;!function(){var a=document.getElementsByClassName("search")[0];searchMain.linkInput(a),console.log(searchMain.boxNode.onclick)}(),addEvent(searchMain.resultsNode,"click",function(a){a=a||window.event;for(var b=a.target||a.srcElement;!b.classList.contains("searchResults__itemSelectArea");){if(b==searchMain.resultsNode)return;b=b.parentNode}var c=b.getElementsByClassName("searchResults__itemText")[0].getAttribute("datetime");year=+c.slice(0,4),day=+c.slice(8,10),month=+c.slice(5,7)-1,monthTableMain.selectCell(month,day,year);var d=monthSelector.getElementsByClassName("monthSelector__month")[0];d.innerHTML=monthNames[monthTableMain.date.getMonth()]+" "+monthTableMain.date.getFullYear()}),document.onclick=function(a){a=a||window.event;for(var b=a.target||a.srcElement;b!=this&&b!=searchMain.resultsNode&&b!=searchMain.boxNode;)b=b.parentNode;b==this&&searchMain.hideResults()},addEvent(searchMain.inputNode,"focus",function(){hideDetailForm(),hideBasicForm(),monthTableMain.clearSelection()});